name: Deploy Infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'infra/helm-charts/postgres/**'
      - 'infra/helm-charts/weaviate/**'
      - '.github/workflows/deploy-infrastructure.yml'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'infra/helm-charts/postgres/**'
      - 'infra/helm-charts/weaviate/**'
      - '.github/workflows/deploy-infrastructure.yml'
  workflow_dispatch:
    inputs:
      postgres_persistence_size:
        description: 'PostgreSQL persistence size'
        required: false
        default: '1Gi'
      weaviate_persistence_size:
        description: 'Weaviate persistence size'
        required: false
        default: '1Gi'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kubernetes tools
        run: |
          echo "ğŸ”§ Setting up Kubernetes tools..."
          
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          
          # Install Helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          echo "âœ… Kubernetes tools installed"
          kubectl version --client
          helm version

      - name: Configure kubectl
        run: |
          echo "ğŸ”§ Configuring kubectl..."
          
          # Set up kubectl configuration
          mkdir -p $HOME/.kube
          cat > $HOME/.kube/config << 'EOF'
          apiVersion: v1
          kind: Config
          clusters:
          - name: "student"
            cluster:
              server: "https://rancher.ase.cit.tum.de/k8s/clusters/c-m-nhcfjg9h"
          
          users:
          - name: "student"
            user:
              token: "kubeconfig-u-g7fbq4tzcsrjvb2:dtw5qr2nkwl5hl4r676dlmt7v9lh9bw5xgkp5l65pf6tr6ql79zsmm"
          
          contexts:
          - name: "student"
            context:
              user: "student"
              cluster: "student"
          
          current-context: "student"
          EOF
          chmod 600 $HOME/.kube/config
          
          echo "âœ… Kubectl configured"
          
          # Test connection
          echo "ğŸ” Testing cluster connection..."
          kubectl cluster-info || {
            echo "âŒ Failed to connect to cluster"
            exit 1
          }
          echo "âœ… Cluster connection successful"

      - name: Deploy PostgreSQL
        if: ${{ github.event.inputs.deploy_postgres != 'false' }}
        run: |
          echo "ğŸš€ Deploying PostgreSQL..."
          
          # Ensure namespace exists
          kubectl create namespace study-mate --dry-run=client -o yaml | kubectl apply -f -
          
          # Deploy PostgreSQL with secrets
          helm upgrade --install postgres ./infra/helm-charts/postgres -n study-mate \
            --set teamid=study-mate \
            --set secrets.postgres.data.password="${{ secrets.POSTGRES_PASSWORD }}" \
            --wait --timeout=10m || {
            echo "âŒ PostgreSQL deployment failed"
            echo "ğŸ” Checking deployment status..."
            helm status postgres -n study-mate || echo "âš ï¸  Could not get release status"
            echo "ğŸ” Checking pod status..."
            kubectl get pods -n study-mate -l app.kubernetes.io/name=postgres || echo "âš ï¸  Could not get pod status"
            exit 1
          }
          
          echo "âœ… PostgreSQL deployed successfully"

      - name: Deploy Weaviate
        if: ${{ github.event.inputs.deploy_weaviate != 'false' }}
        run: |
          echo "ğŸš€ Deploying Weaviate..."
          
          # Ensure namespace exists
          kubectl create namespace study-mate --dry-run=client -o yaml | kubectl apply -f -
          
          # Deploy Weaviate
          helm upgrade --install weaviate ./infra/helm-charts/weaviate -n study-mate \
            --set teamid=study-mate \
            --wait --timeout=10m || {
            echo "âŒ Weaviate deployment failed"
            echo "ğŸ” Checking deployment status..."
            helm status weaviate -n study-mate || echo "âš ï¸  Could not get release status"
            echo "ğŸ” Checking pod status..."
            kubectl get pods -n study-mate -l app.kubernetes.io/name=weaviate || echo "âš ï¸  Could not get pod status"
            exit 1
          }
          
          echo "âœ… Weaviate deployed successfully"

      - name: Verify Infrastructure
        run: |
          echo "ğŸ” Verifying infrastructure deployment..."
          
          # Check PostgreSQL
          if kubectl get deployment postgres -n study-mate > /dev/null 2>&1; then
            echo "ğŸ“Š Checking PostgreSQL..."
            kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=postgres -n study-mate --timeout=300s || {
              echo "âŒ PostgreSQL pod failed to become ready"
              kubectl get pods -n study-mate -l app.kubernetes.io/name=postgres -o wide
            }
            echo "âœ… PostgreSQL is ready"
          fi
          
          # Check Weaviate
          if kubectl get deployment weaviate -n study-mate > /dev/null 2>&1; then
            echo "ğŸ” Checking Weaviate..."
            kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=weaviate -n study-mate --timeout=300s || {
              echo "âŒ Weaviate pod failed to become ready"
              kubectl get pods -n study-mate -l app.kubernetes.io/name=weaviate -o wide
            }
            echo "âœ… Weaviate is ready"
          fi
          
          # Check services
          echo "ğŸ”§ Checking services..."
          kubectl get services -n study-mate -l app.kubernetes.io/name=postgres || echo "âš ï¸  PostgreSQL service not found"
          kubectl get services -n study-mate -l app.kubernetes.io/name=weaviate || echo "âš ï¸  Weaviate service not found"
          
          # Check PVCs
          echo "ğŸ’¾ Checking persistent volumes..."
          kubectl get pvc -n study-mate

      - name: Infrastructure Health Check
        run: |
          echo "ğŸ¥ Performing infrastructure health checks..."
          
          # PostgreSQL health check
          if kubectl get service postgres -n study-mate > /dev/null 2>&1; then
            echo "ğŸ” Testing PostgreSQL connection..."
            kubectl port-forward svc/postgres 5432:5432 -n study-mate &
            PF_PID=$!
            sleep 10
            
            if timeout 10 bash -c 'until pg_isready -h localhost -p 5432; do sleep 1; done' 2>/dev/null; then
              echo "âœ… PostgreSQL health check passed"
            else
              echo "âŒ PostgreSQL health check failed"
            fi
            
            kill $PF_PID 2>/dev/null || true
          fi
          
          # Weaviate health check
          if kubectl get service weaviate -n study-mate > /dev/null 2>&1; then
            echo "ğŸ” Testing Weaviate connection..."
            kubectl port-forward svc/weaviate 8087:8087 -n study-mate &
            PF_PID=$!
            sleep 10
            
            if curl -f http://localhost:8087/v1/.well-known/ready > /dev/null 2>&1; then
              echo "âœ… Weaviate health check passed"
            else
              echo "âŒ Weaviate health check failed"
            fi
            
            kill $PF_PID 2>/dev/null || true
          fi

      - name: Deployment Summary
        run: |
          echo "ğŸ—ï¸  Infrastructure Deployment Complete!"
          echo "ğŸ“¦ Namespace: study-mate"
          echo ""
          echo "ğŸ”§ Deployed Services:"
          kubectl get deployments -n study-mate --no-headers | awk '{print "  - " $1}'
          echo ""
          echo "ğŸ”§ Useful commands:"
          echo "  kubectl get pods -n study-mate"
          echo "  kubectl get services -n study-mate"
          echo "  kubectl get pvc -n study-mate"
          echo "  kubectl logs -f deployment/postgres -n study-mate"
          echo "  kubectl logs -f deployment/weaviate -n study-mate"
          echo ""
          echo "ğŸ” Troubleshooting:"
          echo "  kubectl get events -n study-mate --sort-by='.lastTimestamp'"
          echo "  helm status postgres -n study-mate"
          echo "  helm status weaviate -n study-mate" 