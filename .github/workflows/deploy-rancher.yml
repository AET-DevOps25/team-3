name: Deploy StudyMate to Rancher

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod
      domain:
        description: 'Domain name for deployment'
        required: true
        default: 'studymate.student.k8s.aet.cit.tum.de'

jobs:
  deploy-rancher:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          cat > ~/.kube/config << 'EOF'
          apiVersion: v1
          kind: Config
          clusters:
          - name: "student"
            cluster:
              server: "https://rancher.ase.cit.tum.de/k8s/clusters/c-m-nhcfjg9h"
          
          users:
          - name: "student"
            user:
              token: "kubeconfig-u-g7fbq4tzcsm6z76:btctl45d2sfw7fvdzplvdfzr6cnwbnnmzwtxpzjq4xjbnlp5bmrvzs"
          
          contexts:
          - name: "student"
            context:
              user: "student"
              cluster: "student"
          
          current-context: "student"
          EOF
          chmod 600 ~/.kube/config
          
          echo "ğŸ” Testing kubeconfig..."
          kubectl config view --minify
          echo "âœ… Kubeconfig created successfully"

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Verify Kubernetes connection
        run: |
          echo "ğŸ” Testing Kubernetes connection..."
          kubectl cluster-info || echo "âš ï¸  Cluster info not available, but continuing..."
          kubectl get namespaces || echo "âš ï¸  Cannot list namespaces, but continuing..."
          
          # Check current user and permissions
          echo "ğŸ‘¤ Current user: $(kubectl config view --minify -o jsonpath='{.users[0].name}')"
          echo "ğŸ”‘ Testing permissions..."
          kubectl auth can-i list pods --all-namespaces || echo "âš ï¸  Cannot list pods across namespaces"
          kubectl auth can-i create namespaces || echo "âš ï¸  Cannot create namespaces"
          kubectl auth can-i delete namespaces || echo "âš ï¸  Cannot delete namespaces"
          
          echo "âœ… Kubernetes tools ready"

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.OPEN_WEBUI_API_KEY_CHAT }}" ]; then
            echo "âŒ OPEN_WEBUI_API_KEY_CHAT secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.OPEN_WEBUI_API_KEY_GEN }}" ]; then
            echo "âŒ OPEN_WEBUI_API_KEY_GEN secret is not set"
            exit 1
          fi

          echo "âœ… All required secrets are present"
      - name: Deploy to Rancher
        env:
          OPEN_WEBUI_API_KEY_CHAT: ${{ secrets.OPEN_WEBUI_API_KEY_CHAT }}
          OPEN_WEBUI_API_KEY_GEN: ${{ secrets.OPEN_WEBUI_API_KEY_GEN }}
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
        run: |
          # Always delete the namespace to ensure clean slate
          echo "ğŸ—‘ï¸  Cleaning up existing namespace..."
          kubectl delete namespace team-3 --ignore-not-found=true
          sleep 15  # Wait for deletion to complete
          
          # Verify namespace is gone
          if kubectl get namespace team-3 &> /dev/null; then
            echo "âš ï¸  Namespace still exists, waiting longer..."
            sleep 30
            kubectl delete namespace team-3 --ignore-not-found=true --force --grace-period=0
            sleep 10
          fi
          
          echo "âœ… Namespace cleanup completed"
          
          chmod +x ./deploy-k8s.sh
          ./deploy-k8s.sh \
            --env ${{ github.event.inputs.environment || 'dev' }} \
            --domain ${{ github.event.inputs.domain || 'studymate.student.k8s.aet.cit.tum.de' }}

      - name: Verify deployment
        run: |
          echo "ğŸ” Checking deployment status..."
          kubectl get pods -n team-3 -l app.kubernetes.io/instance=studymate || echo "No pods found yet"
          kubectl get services -n team-3 -l app.kubernetes.io/instance=studymate || echo "No services found yet"
          
          echo "ğŸ¥ Checking pod health..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=studymate -n team-3 --timeout=300s || echo "Pod health check skipped"

      - name: Get access information
        run: |
          echo "ğŸŒ Access Information:"
          echo "Domain: ${{ github.event.inputs.domain || 'studymate.student.k8s.aet.cit.tum.de' }}"
          echo ""
          echo "ğŸ”— Useful commands:"
          echo "kubectl get pods -n team-3"
          echo "kubectl logs -f deployment/studymate-client -n team-3"
          echo "kubectl port-forward svc/studymate-client 8080:80 -n team-3" 