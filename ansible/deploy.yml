---
- name: Deploy App Stack
  hosts: ec2
  become: true

  vars:
    project_dir: /home/ubuntu/app

  tasks:
    - include_tasks: tasks/env_vars.yml # load env variables
    
    - name: Ensure project directory exists
      file:
        path: "{{ project_dir }}"
        state: directory

    - name: Template compose with image tags
      template:
        src: ../docker-compose.yml.j2
        dest: "{{ project_dir }}/docker-compose.yml"

    - name: Copy database setup script for microservices
      copy:
        src: ../database_setup_microservices.sql
        dest: "{{ project_dir }}/database_setup_microservices.sql"

    - name: Copy Traefik configuration files
      copy:
        src: ../traefik/
        dest: "{{ project_dir }}/traefik/"

    - name: Create acme.json file for Let's Encrypt certificates
      file:
        path: "{{ project_dir }}/traefik/acme.json"
        state: touch
        mode: '0600'
        owner: root
        group: root

    - name: Copy Prometheus configuration files
      copy:
        src: ../monitoring/prometheus/
        dest: "{{ project_dir }}/monitoring/prometheus/"

    - name: Copy Grafana configuration files
      copy:
        src: ../monitoring/grafana/
        dest: "{{ project_dir }}/monitoring/grafana/"

    - name: Log in to GHCR
      shell: |
        echo "{{ lookup('env','GITHUB_TOKEN') }}" | docker login ghcr.io -u "{{ lookup('env','GITHUB_ACTOR') }}" --password-stdin

    - name: Pull latest images
      shell: docker-compose pull
      args:
        chdir: "{{ project_dir }}"

    - name: Run stack
      shell: docker-compose up -d
      args:
        chdir: "{{ project_dir }}"
